<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>n8n Webhook Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #c3a7ff 0%, #8f6fff 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .chat-container {
      position: fixed;
      bottom: 32px;
      right: 32px;
      max-width: 400px;
      width: 400px;
      height: 600px;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(143,111,255,0.18);
      z-index: 999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #ece6ff;
    }
    .chat-header {
      background: linear-gradient(90deg, #8f6fff 60%, #c3a7ff 100%);
      color: #fff;
      font-weight: 600;
      font-size: 1.35rem;
      font-family: 'Poppins', sans-serif;
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      box-shadow: 0 2px 8px rgba(143,111,255,0.18);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
    }
    .chat-header-title {
      @media (max-width: 900px) {
        .chat-container {
          position: fixed;
          max-width: 100vw;
          width: 100vw;
          height: 100vh;
          border-radius: 0;
          bottom: 0;
          right: 0;
          left: 0;
          top: 0;
        }
        .chat-header {
          border-radius: 0;
          font-size: 1rem;
          height: 48px;
        }
        .chat-header-title {
          font-size: 0.98rem;
          padding-left: 16px;
        }
        .chat-history {
          min-height: 120px;
          max-height: 60vh;
          padding: 7px 7px 4px 7px;
          gap: 6px;
        }
        .bubble {
          font-size: 0.78rem;
          padding: 6px 10px;
        }
        .chat-input {
          padding: 7px;
          border-radius: 0;
          width: 100vw;
          box-sizing: border-box;
        }
        .chat-input input {
          font-size: 0.78rem;
          padding: 5px 7px;
          min-width: 0;
        }
        .chat-input button[type="submit"] {
          font-size: 0.78rem;
          padding: 0 8px;
          max-width: 80px;
          min-width: 50px;
          height: 34px;
        }
        #typingIndicator {
          font-size: 0.78rem !important;
        }
        .chatbot-icon {
          width: 40px;
          height: 40px;
          font-size: 18px;
          bottom: 10px;
          right: 10px;
        }
      }
      font-size: 0.95rem;
      line-height: 1.3;
      box-shadow: 0 2px 12px rgba(143,111,255,0.10);
      margin-bottom: 4px;
      word-break: break-word;
      border: 1.5px solid #f0eaff;
    }
    .user-bubble {
      background: linear-gradient(135deg, #b699ff 0%, #8f6fff 100%);
      color: #fff;
      font-weight: 500;
      border: 0px;
      margin-left: 32px;
      margin-right: 0;
    }
    .bot-bubble {
      background: #fff;
      color: #7c63ff;
      font-weight: 500;
      margin-right: 32px;
      margin-left: 0;
      border: 1.2px solid #e3d4ff;
    }
    .chat-input {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 18px 19px 18px 19px;
      background: #fff;
      border-bottom-left-radius: 24px;
      border-bottom-right-radius: 24px;
      border-top: 1px solid #ece6ff;
      margin-top: 0;
      box-sizing: border-box;
    }
    .chat-input input {
      flex: 1;
      padding: 10px 16px;
      border: none;
      outline: none;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      border-radius: 11px;
      background: #f6f3ff;
      color: #7954fe;
      margin-right: 4px;
      box-shadow: 0 2px 8px #e4dafc;
    }
    .chat-input button[type="submit"] {
      background: #8f6fff;
      color: #fff;
      border: none;
      padding: 0 20px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      letter-spacing: 0.5px;
      border-radius: 11px;
      box-shadow: 0 2px 8px rgba(143,111,255,0.12);
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chat-input button[type="submit"]:hover {
      background: #a48bfe;
    }
    .error-banner {
      color: #fff;
      background: #e74c3c;
      padding: 13px 20px;
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 1.02rem;
      text-align: center;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px #efacbe;
    }
    .chatbot-icon {
      display: none;
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: linear-gradient(135deg, #a18fff 0%, #6d4aff 100%);
      color: #fff;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      box-shadow: 0 2px 16px #a18fff;
      justify-content: center;
      align-items: center;
      font-size: 28px;
      cursor: pointer;
      z-index: 1000;
    }
    /* Code block styling */
    .code-bubble {
      background: #0f1724;
      color: #e6edf3;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace;
      font-size: 0.9rem;
      padding: 14px 18px;
      border-radius: 14px;
      max-width: 90%;
      overflow: auto;
      box-shadow: 0 6px 24px rgba(2,6,23,0.4);
      border: 1px solid rgba(255,255,255,0.04);
      white-space: pre;
      margin-bottom: 8px;
    }
    .code-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 6px;
    }
    .copy-btn {
      background: rgba(255,255,255,0.06);
      color: #e6edf3;
      border: none;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    @media (max-width: 500px) {
      .chat-container { max-width: 100%; width: 100%; height: 100%; border-radius: 0; }
      .chat-header { border-radius: 0; }
      .chat-history { min-height: 160px; max-height: 200px; padding: 10px; }
      .chat-input { padding: 10px; border-radius: 0; }
      .chatbot-icon { width: 44px; height: 44px; font-size: 22px; bottom: 12px; right: 12px; }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <span class="chat-header-title">My Assistant</span>
      <span class="chat-header-actions">
        <button id="minimizeBtn" title="Minimize">&#x2013;</button>
        <button id="reloadBtn" title="Reload">&#x21bb;</button>
        <button id="closeBtn" title="Close">&#x2715;</button>
      </span>
    </div>
    <div class="chat-history" id="history">
      <div class="msg msg-bot"><span class="bubble bot-bubble">Hello! How can I help you today?</span></div>
      <div id="typingIndicator" style="display:none; color:#7c63ff; font-size:1.05rem; margin-left:8px; margin-bottom:8px;">Bot is typing<span id="dots">...</span></div>
    </div>
    <form class="chat-input" id="form">
      <input id="input" type="text" placeholder="Type your message..." required autofocus />
      <button type="submit">Send</button>
    </form>
  </div>
  <div class="chatbot-icon" id="chatbotIcon" title="Open Chatbot">&#128172;</div>
  <script>
    // load highlight.js dynamically
    (function loadHLJS(){
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js';
      s.onload = () => { if (window.hljs) window.hljs.configure({ignoreUnescapedHTML:true}); };
      document.head.appendChild(s);
    })();
    const chatContainer = document.querySelector('.chat-container');
    const chatHistory = document.getElementById('history');
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const minimizeBtn = document.getElementById('minimizeBtn');
    const reloadBtn = document.getElementById('reloadBtn');
    const closeBtn = document.getElementById('closeBtn');
    const chatbotIcon = document.getElementById('chatbotIcon');
    const webhookUrl = 'https://arulvelu21.duckdns.org/webhook/33132d92-0e8e-479a-8d71-c643329ed8c7'; // Replace with your webhook
    // Simple session management
    function generateGUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    let chatSessionId = sessionStorage.getItem('chatSessionId');
    if (!chatSessionId) {
      chatSessionId = generateGUID();
      sessionStorage.setItem('chatSessionId', chatSessionId);
    }
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function appendMessage(msg, sender) {
      const div = document.createElement('div');
      div.classList.add('msg', sender === 'user' ? 'msg-user' : 'msg-bot');

      // Detect fenced code block ```code```
      const codeFenceMatch = msg.match(/```([\s\S]*?)```/m);
      if (codeFenceMatch) {
        const code = codeFenceMatch[1];
        // actions (copy)
        const actions = document.createElement('div');
        actions.className = 'code-actions';
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'Copy';
        actions.appendChild(copyBtn);

        const pre = document.createElement('pre');
        pre.className = 'code-bubble';
        const codeEl = document.createElement('code');
        codeEl.textContent = code;
        pre.appendChild(codeEl);

        div.appendChild(actions);
        div.appendChild(pre);

        // copy handler
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(code).then(() => {
            copyBtn.textContent = 'Copied';
            setTimeout(() => copyBtn.textContent = 'Copy', 1400);
          }).catch(() => {
            copyBtn.textContent = 'Error';
            setTimeout(() => copyBtn.textContent = 'Copy', 1400);
          });
        };

        // syntax highlight if available
        setTimeout(() => {
          if (window.hljs && codeEl) {
            try { window.hljs.highlightElement(codeEl); } catch (e) { /* ignore */ }
          }
        }, 30);
      } else {
        const bubble = document.createElement('span');
        bubble.classList.add('bubble', sender === 'user' ? 'user-bubble' : 'bot-bubble');
        bubble.innerHTML = escapeHtml(msg).replace(/\n/g, '<br/>');
        div.appendChild(bubble);
      }

      chatHistory.appendChild(div);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // Typing indicator logic
    const typingIndicator = document.getElementById('typingIndicator');
    let typingDotsInterval;
    function showTypingIndicator() {
      typingIndicator.style.display = '';
      let dots = document.getElementById('dots');
      let dotCount = 0;
      typingDotsInterval = setInterval(() => {
        dotCount = (dotCount + 1) % 4;
        dots.textContent = '.'.repeat(dotCount || 3);
      }, 500);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    function hideTypingIndicator() {
      typingIndicator.style.display = 'none';
      clearInterval(typingDotsInterval);
    }
    function showError(msg) {
      // Only one error banner at a time
      let banners = document.getElementsByClassName('error-banner');
      while(banners.length) banners[0].remove();
      const errorBanner = document.createElement('div');
      errorBanner.className = 'error-banner';
      errorBanner.textContent = msg;
      chatHistory.prepend(errorBanner);
    }
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      appendMessage(text, 'user');
      input.value = '';
      showTypingIndicator();
      try {
        const res = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatInput: text, chatSessionId })
        });
        hideTypingIndicator();
        if (res.ok) {
          let data = await res.json();
          // Handle array or object response
          let botReply = '';
          if (Array.isArray(data) && data.length && data[0].output) {
            botReply = data[0].output;
          } else if (data.output) {
            botReply = data.output;
          } else if (data.reply) {
            botReply = data.reply;
          }
          appendMessage(botReply || "Sorry, I didn't get that.", 'bot');
        } else {
          showError('Sorry, connection failed. Please try again.');
        }
      } catch (err) {
        hideTypingIndicator();
        showError('Sorry, connection failed. Please check your internet or try again later.');
      }
    });
    // Button logic
    minimizeBtn.onclick = function() {
      chatContainer.style.display = 'none';
      chatbotIcon.style.display = 'flex';
    };
    reloadBtn.onclick = function() {
      chatHistory.innerHTML = '<div class="msg msg-bot"><span class="bubble bot-bubble">Hello! How can I help you today?</span></div>';
      let banners = document.getElementsByClassName('error-banner');
      while(banners.length) banners[0].remove();
    };
    closeBtn.onclick = function() {
      chatContainer.style.display = 'none';
      chatbotIcon.style.display = 'flex';
      chatHistory.innerHTML = '<div class="msg msg-bot"><span class="bubble bot-bubble">Hello! How can I help you today?</span></div>';
      let banners = document.getElementsByClassName('error-banner');
      while(banners.length) banners[0].remove();
    };
    chatbotIcon.onclick = function() {
      chatContainer.style.display = '';
      chatbotIcon.style.display = 'none';
    };
  </script>
</body>
</html>
