<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>n8n Webhook Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #c3a7ff 0%, #8f6fff 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .chat-container {
      position: fixed;
      bottom: 32px;
      right: 32px;
      max-width: 400px;
      width: 100%;
      height: 600px;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(143,111,255,0.18);
      z-index: 999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #ece6ff;
    }
    .chat-header {
      background: linear-gradient(90deg, #8f6fff 60%, #c3a7ff 100%);
      color: #fff;
      font-weight: 600;
      font-size: 1.35rem;
      font-family: 'Poppins', sans-serif;
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      box-shadow: 0 2px 8px rgba(143,111,255,0.18);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
    }
    .chat-header-title {
      padding-left: 28px;
      font-size: 1.28rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: #fff;
      flex: 1;
      user-select: none;
    }
    .chat-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-right: 20px;
    }
    .chat-header-actions button {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .chat-header-actions button:hover {
      background: rgba(255,255,255,0.12);
    }
    .chat-history {
      flex: 1;
      min-height: 420px;
      max-height: 470px;
      overflow-y: auto;
      padding: 20px 20px 8px 20px;
      background: #faf8ff;
      display: flex;
      flex-direction: column;
      gap: 14px;
      box-sizing: border-box;
      margin-bottom: 4px;
    }
    .msg { margin-bottom: 0px; }
    .msg-user { 
      text-align: right;
      display: flex;
      flex-direction: row-reverse;
    }
    .msg-bot { 
      text-align: left;
      display: flex;
      flex-direction: row;
    }
    .bubble {
      display: inline-block;
      padding: 14px 20px;
      border-radius: 16px;
      max-width: 75%;
      font-size: 1.05rem;
      line-height: 1.5;
      margin: 2px 0;
      word-break: break-word;
      box-shadow: 0 2px 10px rgba(143,111,255,0.09);
      border: 1.2px solid #e3d4ff;
    }
    .user-bubble {
      background: linear-gradient(135deg, #b699ff 0%, #8f6fff 100%);
      color: #fff;
      font-weight: 500;
      border: 0px;
      margin-left: 32px;
      margin-right: 0;
    }
    .bot-bubble {
      background: #fff;
      color: #7c63ff;
      font-weight: 500;
      margin-right: 32px;
      margin-left: 0;
      border: 1.2px solid #e3d4ff;
    }
    .chat-input {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 18px 19px 18px 19px;
      background: #fff;
      border-bottom-left-radius: 24px;
      border-bottom-right-radius: 24px;
      border-top: 1px solid #ece6ff;
      margin-top: 0;
      box-sizing: border-box;
    }
    .chat-input input {
      flex: 1;
      padding: 10px 16px;
      border: none;
      outline: none;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      border-radius: 11px;
      background: #f6f3ff;
      color: #7954fe;
      margin-right: 4px;
      box-shadow: 0 2px 8px #e4dafc;
    }
    .chat-input button[type="submit"] {
      background: #8f6fff;
      color: #fff;
      border: none;
      padding: 0 20px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      letter-spacing: 0.5px;
      border-radius: 11px;
      box-shadow: 0 2px 8px rgba(143,111,255,0.12);
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chat-input button[type="submit"]:hover {
      background: #a48bfe;
    }
    .error-banner {
      color: #fff;
      background: #e74c3c;
      padding: 13px 20px;
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 1.02rem;
      text-align: center;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px #efacbe;
    }
    .chatbot-icon {
      display: none;
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: linear-gradient(135deg, #a18fff 0%, #6d4aff 100%);
      color: #fff;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      box-shadow: 0 2px 16px #a18fff;
      justify-content: center;
      align-items: center;
      font-size: 28px;
      cursor: pointer;
      z-index: 1000;
    }
    @media (max-width: 500px) {
      .chat-container { max-width: 100%; width: 100%; height: 100%; border-radius: 0; }
      .chat-header { border-radius: 0; }
      .chat-history { min-height: 160px; max-height: 200px; padding: 10px; }
      .chat-input { padding: 10px; border-radius: 0; }
      .chatbot-icon { width: 44px; height: 44px; font-size: 22px; bottom: 12px; right: 12px; }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <span class="chat-header-title">My Assistant</span>
      <span class="chat-header-actions">
        <button id="minimizeBtn" title="Minimize">&#x2013;</button>
        <button id="reloadBtn" title="Reload">&#x21bb;</button>
        <button id="closeBtn" title="Close">&#x2715;</button>
      </span>
    </div>
    <div class="chat-history" id="history">
      <div class="msg msg-bot"><span class="bubble bot-bubble">Hello! How can I help you today?</span></div>
    </div>
    <form class="chat-input" id="form">
      <input id="input" type="text" placeholder="Type your message..." required autofocus />
      <button type="submit">Send</button>
    </form>
  </div>
  <div class="chatbot-icon" id="chatbotIcon" title="Open Chatbot">&#128172;</div>
  <script>
    const chatContainer = document.querySelector('.chat-container');
    const chatHistory = document.getElementById('history');
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const minimizeBtn = document.getElementById('minimizeBtn');
    const reloadBtn = document.getElementById('reloadBtn');
    const closeBtn = document.getElementById('closeBtn');
    const chatbotIcon = document.getElementById('chatbotIcon');
    const webhookUrl = 'https://arulvelu21.duckdns.org/webhook/33132d92-0e8e-479a-8d71-c643329ed8c7'; // Replace with your webhook
    // Simple session management
    function generateGUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    let chatSessionId = sessionStorage.getItem('chatSessionId');
    if (!chatSessionId) {
      chatSessionId = generateGUID();
      sessionStorage.setItem('chatSessionId', chatSessionId);
    }
    function appendMessage(msg, sender) {
      const div = document.createElement('div');
      div.classList.add('msg', sender === 'user' ? 'msg-user' : 'msg-bot');
      const bubble = document.createElement('span');
      bubble.classList.add('bubble', sender === 'user' ? 'user-bubble' : 'bot-bubble');
      bubble.textContent = msg;
      div.appendChild(bubble);
      chatHistory.appendChild(div);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    function showError(msg) {
      // Only one error banner at a time
      let banners = document.getElementsByClassName('error-banner');
      while(banners.length) banners[0].remove();
      const errorBanner = document.createElement('div');
      errorBanner.className = 'error-banner';
      errorBanner.textContent = msg;
      chatHistory.prepend(errorBanner);
    }
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      appendMessage(text, 'user');
      input.value = '';
      try {
        const res = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatInput: text, chatSessionId })
        });
        if (res.ok) {
          let data = await res.json();
          appendMessage(data.reply || "Sorry, I didn't get that.", 'bot');
        } else {
          showError('Sorry, connection failed. Please try again.');
        }
      } catch (err) {
        showError('Sorry, connection failed. Please check your internet or try again later.');
      }
    });
    // Button logic
    minimizeBtn.onclick = function() {
      chatContainer.style.display = 'none';
      chatbotIcon.style.display = 'flex';
    };
    reloadBtn.onclick = function() {
      chatHistory.innerHTML = '<div class="msg msg-bot"><span class="bubble bot-bubble">Hello! How can I help you today?</span></div>';
      let banners = document.getElementsByClassName('error-banner');
      while(banners.length) banners[0].remove();
    };
    closeBtn.onclick = function() {
      chatContainer.style.display = 'none';
      chatbotIcon.style.display = 'flex';
      chatHistory.innerHTML = '<div class="msg msg-bot"><span class="bubble bot-bubble">Hello! How can I help you today?</span></div>';
      let banners = document.getElementsByClassName('error-banner');
      while(banners.length) banners[0].remove();
    };
    chatbotIcon.onclick = function() {
      chatContainer.style.display = '';
      chatbotIcon.style.display = 'none';
    };
  </script>
</body>
</html>
